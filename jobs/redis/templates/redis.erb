#!/bin/bash

REDIS_HOME="/var/vcap/packages/redis";
REDIS_SERVER="${REDIS_HOME}/bin/redis-server";
REDIS_CLI="${REDIS_HOME}/bin/redis-cli";
REDIS_RUN_DIR="/var/vcap/sys/run/redis";
REDIS_LOG_DIR="/var/vcap/sys/log/redis";
REDIS_PID_FILE="${REDIS_RUN_DIR}/redis.pid";
REDIS_CONF="/var/vcap/jobs/redis/config/redis.conf";
REDIS_PORT="6379";
REDIS_PID;

case "${1}" in
  start)
    if [[ -f "${REDIS_PID_FILE}" ]];
    then
      echo "${REDIS_PID_FILE} exists, process is already running or crashed";
    else
      echo "Starting Redis server...";
      ${REDIS_SERVER} ${REDIS_CONF};
    fi
    ;;
  stop)
    if [[ -f "${REDIS_PID_FILE}" ]];
    then
      echo "${REDIS_PID_FILE} does not exist, process is not running";
    else
      REDIS_PID="$(cat ${REDIS_PID_FILE})";
      echo "Stopping ...";
      ${REDIS_CLI} -p ${REDIS_PORT} shutdown;
      while [[ -x "/proc/${REDIS_PID}" ]];
      do
        echo "Waiting for Redis to shutdown ...";
        sleep 1;
      done
      echo "Redis stopped";
    fi
    ;;
  *)
    echo "Usage: ${0} {start|stop}";
  ;;
esac
